name: Append to JSON Array in File

on:
  workflow_dispatch:
    inputs:
      id:
        description: "ID of the new object"
        required: true
      name:
        description: "Name of the new object"
        required: true

jobs:
  append-json:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Append dynamic object to JSON array in GitHub file
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        FILE_PATH="data/mydata.json"
        TARGET_ID=${{ github.event.inputs.id }}
        TARGET_NAME="${{ github.event.inputs.name }}"

        # Create the object and save it to a file
        echo "{\"id\": $TARGET_ID, \"name\": \"$TARGET_NAME\"}" > new_object.json

        # Fetch file and SHA
        RESPONSE=$(curl -s -H "Authorization: token $GH_TOKEN" \
          https://api.github.com/repos/${{ github.repository }}/contents/$FILE_PATH)

        SHA=$(echo "$RESPONSE" | jq -r .sha)
        CONTENT=$(echo "$RESPONSE" | jq -r .content | base64 -d)

        # Append new object using jq
        UPDATED_JSON=$(echo "$CONTENT" | jq --slurpfile newObj new_object.json '. + $newObj')

        # Encode to base64
        UPDATED_BASE64=$(echo "$UPDATED_JSON" | base64 -w 0)

        # Prepare PUT request
        echo "{
          \"message\": \"Append new object to JSON array\",
          \"content\": \"$UPDATED_BASE64\",
          \"sha\": \"$SHA\"
        }" > body.json

        # Commit updated JSON to GitHub
        curl -X PUT \
          -H "Authorization: token $GH_TOKEN" \
          -H "Content-Type: application/json" \
          --data @body.json \
          https://api.github.com/repos/${{ github.repository }}/contents/$FILE_PATH
